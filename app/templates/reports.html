{% extends "base.html" %}

{% block title %}Reports - Unraid Dedupe{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <h2 class="text-3xl font-bold text-dark-50">Reports</h2>
        <div class="flex gap-2">
            <div class="relative flex-1 sm:flex-initial">
                <input
                    type="text"
                    id="search-input"
                    placeholder="Search reports..."
                    class="w-full sm:w-64 pl-10 pr-4 py-2 bg-dark-800 border border-dark-700 rounded-lg text-dark-200 placeholder-dark-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                    aria-label="Search reports">
                <svg class="absolute left-3 top-2.5 w-5 h-5 text-dark-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            <select id="sort-select"
                    onchange="sortReports()"
                    class="px-4 py-2 bg-dark-800 border border-dark-700 rounded-lg text-dark-200 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-all cursor-pointer"
                    aria-label="Sort reports">
                <option value="date-desc">Newest First</option>
                <option value="date-asc">Oldest First</option>
                <option value="size-desc">Most Space</option>
                <option value="size-asc">Least Space</option>
                <option value="sets-desc">Most Sets</option>
                <option value="sets-asc">Least Sets</option>
            </select>
        </div>
    </div>

    <!-- Bulk Actions Bar (Hidden by default) -->
    <div id="bulk-actions-bar" class="hidden bg-primary-900/30 border border-primary-700/50 rounded-xl p-4">
        <div class="flex items-center justify-between gap-4">
            <span class="text-primary-300 font-medium">
                <span id="selected-count">0</span> report(s) selected
            </span>
            <div class="flex gap-2">
                <button onclick="clearSelection()"
                        class="px-4 py-2 bg-dark-700 hover:bg-dark-600 text-dark-200 rounded-lg transition-colors">
                    Clear Selection
                </button>
                <button onclick="bulkDeleteReports()"
                        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                    <span class="flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Delete Selected
                    </span>
                </button>
            </div>
        </div>
    </div>

    <div class="bg-dark-800 border border-dark-700 rounded-xl shadow-xl overflow-hidden">
        <div id="reports-list">
            <!-- Skeleton Loader -->
            <div id="skeleton-loader" class="p-6 space-y-4">
                <div class="animate-pulse space-y-4">
                    <div class="h-8 bg-dark-700 rounded w-1/4"></div>
                    <div class="space-y-3">
                        <div class="h-16 bg-dark-700 rounded"></div>
                        <div class="h-16 bg-dark-700 rounded"></div>
                        <div class="h-16 bg-dark-700 rounded"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allReports = [];
    let selectedReports = new Set();

    function loadReports() {
        fetch('/api/reports')
            .then(response => response.json())
            .then(data => {
                allReports = data.reports;
                renderReports(allReports);

                // Setup search
                document.getElementById('search-input').addEventListener('input', (e) => {
                    applyFiltersAndSort();
                });
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('reports-list').innerHTML = `
                    <div class="p-8 text-center">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-900/30 mb-4">
                            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-dark-200 mb-2">Failed to Load Reports</h3>
                        <p class="text-dark-400 mb-4">There was an error loading the reports. Please try again.</p>
                        <button onclick="loadReports()" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-colors">
                            Retry
                        </button>
                    </div>
                `;
            });
    }

    function applyFiltersAndSort() {
        let filtered = [...allReports];

        // Apply search filter
        const query = document.getElementById('search-input').value.toLowerCase();
        if (query) {
            filtered = filtered.filter(report => {
                return report.id.toLowerCase().includes(query) ||
                       new Date(report.generated_at).toLocaleString().toLowerCase().includes(query);
            });
        }

        // Apply sort
        const sortBy = document.getElementById('sort-select').value;
        filtered.sort((a, b) => {
            switch(sortBy) {
                case 'date-desc':
                    return new Date(b.generated_at) - new Date(a.generated_at);
                case 'date-asc':
                    return new Date(a.generated_at) - new Date(b.generated_at);
                case 'size-desc':
                    return b.summary.total_reclaimable - a.summary.total_reclaimable;
                case 'size-asc':
                    return a.summary.total_reclaimable - b.summary.total_reclaimable;
                case 'sets-desc':
                    return b.summary.total_sets - a.summary.total_sets;
                case 'sets-asc':
                    return a.summary.total_sets - b.summary.total_sets;
                default:
                    return 0;
            }
        });

        renderReports(filtered);
    }

    function sortReports() {
        applyFiltersAndSort();
    }

    function toggleReportSelection(reportId, checkbox) {
        if (checkbox.checked) {
            selectedReports.add(reportId);
        } else {
            selectedReports.delete(reportId);
        }
        updateBulkActionsBar();
    }

    function updateBulkActionsBar() {
        const bar = document.getElementById('bulk-actions-bar');
        const count = document.getElementById('selected-count');

        count.textContent = selectedReports.size;

        if (selectedReports.size > 0) {
            bar.classList.remove('hidden');
        } else {
            bar.classList.add('hidden');
        }
    }

    function clearSelection() {
        selectedReports.clear();
        document.querySelectorAll('.report-checkbox').forEach(cb => cb.checked = false);
        updateBulkActionsBar();
    }

    function deleteReport(reportId) {
        showModal(
            'Delete Report?',
            `Are you sure you want to delete report ${reportId}? This action cannot be undone.`,
            [
                {
                    text: 'Cancel',
                    primary: false
                },
                {
                    text: 'Delete',
                    danger: true,
                    onClick: () => {
                        fetch(`/api/reports/${reportId}`, { method: 'DELETE' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    showToast('Report deleted successfully', 'success');
                                    // Remove from allReports and re-render
                                    allReports = allReports.filter(r => r.id !== reportId);
                                    selectedReports.delete(reportId);
                                    applyFiltersAndSort();
                                    updateBulkActionsBar();
                                } else {
                                    showToast('Failed to delete report: ' + data.error, 'error');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                showToast('Failed to delete report', 'error');
                            });
                    }
                }
            ]
        );
    }

    function bulkDeleteReports() {
        const count = selectedReports.size;
        showModal(
            'Delete Multiple Reports?',
            `Are you sure you want to delete ${count} report(s)? This action cannot be undone.`,
            [
                {
                    text: 'Cancel',
                    primary: false
                },
                {
                    text: `Delete ${count} Report(s)`,
                    danger: true,
                    onClick: () => {
                        const promises = Array.from(selectedReports).map(id =>
                            fetch(`/api/reports/${id}`, { method: 'DELETE' })
                                .then(response => response.json())
                        );

                        Promise.all(promises)
                            .then(results => {
                                const succeeded = results.filter(r => r.success).length;
                                const failed = results.filter(r => !r.success).length;

                                if (succeeded > 0) {
                                    showToast(`Successfully deleted ${succeeded} report(s)`, 'success');
                                }
                                if (failed > 0) {
                                    showToast(`Failed to delete ${failed} report(s)`, 'error');
                                }

                                // Reload reports
                                loadReports();
                                clearSelection();
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                showToast('Failed to delete reports', 'error');
                            });
                    }
                }
            ]
        );
    }

    function getReportAge(dateStr) {
        const now = new Date();
        const reportDate = new Date(dateStr);
        const diffMs = now - reportDate;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffMinutes = Math.floor(diffMs / (1000 * 60));

        if (diffDays > 1) return `${diffDays} days ago`;
        if (diffDays === 1) return '1 day ago';
        if (diffHours > 1) return `${diffHours} hours ago`;
        if (diffHours === 1) return '1 hour ago';
        if (diffMinutes > 1) return `${diffMinutes} minutes ago`;
        return 'just now';
    }

    function renderReports(reports) {
        const container = document.getElementById('reports-list');

        if (reports.length === 0) {
            const isFiltered = document.getElementById('search-input').value.length > 0;
            container.innerHTML = `
                <div class="p-12 text-center">
                    <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-dark-700/50 mb-4">
                        <svg class="w-10 h-10 text-dark-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            ${isFiltered ?
                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />' :
                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />'
                            }
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-dark-200 mb-2">
                        ${isFiltered ? 'No Matching Reports' : 'No Reports Available'}
                    </h3>
                    <p class="text-dark-400 mb-6 max-w-md mx-auto">
                        ${isFiltered ?
                            'No reports match your search. Try a different search term.' :
                            'You haven\'t generated any deduplication reports yet. Head to the Dashboard to run your first scan.'
                        }
                    </p>
                    ${!isFiltered ?
                        '<a href="/" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-medium rounded-lg shadow-lg hover:shadow-xl transition-all duration-200">Go to Dashboard</a>' :
                        '<button onclick="document.getElementById(\'search-input\').value = \'\'; loadReports();" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 text-dark-200 rounded-lg transition-colors">Clear Search</button>'
                    }
                </div>
            `;
            return;
        }

        // Desktop: Table layout
        let html = `
            <div class="hidden md:block overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-dark-900/80 border-b border-dark-700">
                        <tr>
                            <th class="px-6 py-4 text-left">
                                <input type="checkbox"
                                       onchange="toggleSelectAll(this)"
                                       class="w-5 h-5 rounded border-dark-600 bg-dark-900 text-primary-600 focus:ring-2 focus:ring-primary-500 cursor-pointer"
                                       aria-label="Select all reports">
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-dark-400 uppercase tracking-wider">
                                Report ID
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-dark-400 uppercase tracking-wider">
                                Generated At
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-dark-400 uppercase tracking-wider">
                                Total Sets
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-dark-400 uppercase tracking-wider">
                                Space Reclaimable
                            </th>
                            <th class="px-6 py-4 text-right text-xs font-semibold text-dark-400 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-dark-700">
        `;

        reports.forEach(report => {
            const spaceGB = (report.summary.total_reclaimable / 1024 / 1024 / 1024).toFixed(2);
            const date = new Date(report.generated_at);
            const age = getReportAge(report.generated_at);
            const isChecked = selectedReports.has(report.id) ? 'checked' : '';

            html += `
                <tr class="hover:bg-dark-700/50 transition-colors">
                    <td class="px-6 py-4">
                        <input type="checkbox"
                               ${isChecked}
                               onchange="toggleReportSelection('${report.id}', this)"
                               class="report-checkbox w-5 h-5 rounded border-dark-600 bg-dark-900 text-primary-600 focus:ring-2 focus:ring-primary-500 cursor-pointer"
                               aria-label="Select report ${report.id}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <code class="text-sm font-mono text-primary-400 bg-primary-900/20 px-2 py-1 rounded">
                            ${report.id}
                        </code>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-dark-300">${date.toLocaleString()}</div>
                        <div class="text-xs text-dark-500">${age}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-900/30 text-primary-300 border border-primary-700/50">
                            ${report.summary.total_sets}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center gap-1 text-sm font-semibold text-green-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                            </svg>
                            ${spaceGB} GB
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                        <div class="flex items-center justify-end gap-2">
                            <a href="/reports/${report.id}"
                               class="inline-flex items-center gap-1 px-3 py-1.5 text-primary-400 hover:bg-primary-900/30 rounded-lg font-medium transition-all group">
                                View
                                <svg class="w-4 h-4 group-hover:translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </a>
                            <button onclick="deleteReport('${report.id}')"
                                    class="p-1.5 text-red-400 hover:bg-red-900/30 rounded-lg transition-all"
                                    aria-label="Delete report ${report.id}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        // Mobile: Card layout
        html += '<div class="md:hidden divide-y divide-dark-700">';
        reports.forEach(report => {
            const spaceGB = (report.summary.total_reclaimable / 1024 / 1024 / 1024).toFixed(2);
            const date = new Date(report.generated_at);
            const age = getReportAge(report.generated_at);
            const isChecked = selectedReports.has(report.id) ? 'checked' : '';

            html += `
                <div class="p-4 hover:bg-dark-700/50 transition-colors">
                    <div class="flex items-start gap-3 mb-3">
                        <input type="checkbox"
                               ${isChecked}
                               onchange="toggleReportSelection('${report.id}', this)"
                               class="report-checkbox mt-1 w-5 h-5 rounded border-dark-600 bg-dark-900 text-primary-600 focus:ring-2 focus:ring-primary-500 cursor-pointer"
                               aria-label="Select report ${report.id}">
                        <div class="flex-1">
                            <code class="text-xs font-mono text-primary-400 bg-primary-900/20 px-2 py-1 rounded block w-fit mb-1">
                                ${report.id}
                            </code>
                            <p class="text-xs text-dark-400">${date.toLocaleString()}</p>
                            <p class="text-xs text-dark-500">${age}</p>
                        </div>
                        <div class="flex gap-1">
                            <a href="/reports/${report.id}"
                               class="p-2 text-primary-400 hover:bg-primary-900/30 rounded-lg transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </a>
                            <button onclick="deleteReport('${report.id}')"
                                    class="p-2 text-red-400 hover:bg-red-900/30 rounded-lg transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-dark-900/50 rounded-lg p-3">
                            <p class="text-xs text-dark-400 mb-1">Total Sets</p>
                            <p class="text-lg font-bold text-primary-400">${report.summary.total_sets}</p>
                        </div>
                        <div class="bg-dark-900/50 rounded-lg p-3">
                            <p class="text-xs text-dark-400 mb-1">Reclaimable</p>
                            <p class="text-lg font-bold text-green-400">${spaceGB} GB</p>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';

        container.innerHTML = html;
    }

    function toggleSelectAll(checkbox) {
        document.querySelectorAll('.report-checkbox').forEach(cb => {
            cb.checked = checkbox.checked;
            const reportId = cb.getAttribute('onchange').match(/'([^']+)'/)[1];
            if (checkbox.checked) {
                selectedReports.add(reportId);
            } else {
                selectedReports.delete(reportId);
            }
        });
        updateBulkActionsBar();
    }

    // Pull-to-refresh for mobile
    let touchStartY = 0;
    let touchEndY = 0;
    let isPulling = false;

    document.addEventListener('touchstart', (e) => {
        if (window.scrollY === 0) {
            touchStartY = e.touches[0].clientY;
        }
    }, { passive: true });

    document.addEventListener('touchmove', (e) => {
        if (window.scrollY === 0 && touchStartY > 0) {
            touchEndY = e.touches[0].clientY;
            const pullDistance = touchEndY - touchStartY;

            if (pullDistance > 80 && !isPulling) {
                isPulling = true;
                showToast('Release to refresh...', 'info', 1000);
            }
        }
    }, { passive: true });

    document.addEventListener('touchend', () => {
        if (isPulling) {
            isPulling = false;
            loadReports();
            showToast('Refreshing reports...', 'info', 2000);
        }
        touchStartY = 0;
        touchEndY = 0;
    }, { passive: true });

    document.addEventListener('DOMContentLoaded', loadReports);
</script>
{% endblock %}
