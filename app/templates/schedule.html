{% extends "base.html" %}

{% block title %}Schedule - Unraid Dedupe{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <h2 class="text-3xl font-bold text-dark-50">Scan Schedule</h2>
    </div>

    <!-- Current Schedule Card -->
    <div class="bg-dark-800 border border-dark-700 rounded-xl p-6 shadow-xl">
        <h3 class="text-xl font-semibold text-dark-100 mb-4 pb-3 border-b border-dark-700">Current Schedule</h3>

        <div class="space-y-4">
            <div class="flex items-center gap-3">
                <span class="text-dark-300 font-medium">Status:</span>
                {% if config.enabled %}
                <span class="inline-flex items-center gap-2 px-3 py-1.5 bg-green-900/30 border border-green-700/50 rounded-lg text-green-300 text-sm font-medium">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    Enabled
                </span>
                {% else %}
                <span class="inline-flex items-center gap-2 px-3 py-1.5 bg-dark-700/50 border border-dark-600 rounded-lg text-dark-400 text-sm font-medium">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    Disabled
                </span>
                {% endif %}
            </div>

            {% if config.enabled %}
            <div class="grid sm:grid-cols-2 gap-4">
                <div class="bg-dark-900/50 rounded-lg p-4 border border-dark-700">
                    <p class="text-dark-400 text-xs uppercase tracking-wider mb-1">Schedule</p>
                    <p class="text-dark-200 font-medium">{{ config.description }}</p>
                </div>
                <div class="bg-dark-900/50 rounded-lg p-4 border border-dark-700">
                    <p class="text-dark-400 text-xs uppercase tracking-wider mb-1">Cron Expression</p>
                    <code class="text-primary-400 font-mono text-sm">{{ config.cron }}</code>
                </div>
                {% if config.next_run %}
                <div class="bg-dark-900/50 rounded-lg p-4 border border-dark-700 sm:col-span-2">
                    <p class="text-dark-400 text-xs uppercase tracking-wider mb-1">Next Run</p>
                    <p class="text-dark-200 font-medium">{{ config.next_run }}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <div class="pt-2">
                <button
                    onclick="triggerNow()"
                    class="px-6 py-2.5 bg-dark-700 hover:bg-dark-600 text-dark-200 font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-dark-800">
                    <span class="flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Trigger Scan Now
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- Configure Schedule Card -->
    <div class="bg-dark-800 border border-dark-700 rounded-xl p-6 shadow-xl">
        <h3 class="text-xl font-semibold text-dark-100 mb-4 pb-3 border-b border-dark-700">Configure Schedule</h3>

        <form id="schedule-form" onsubmit="saveSchedule(event)" class="space-y-4">
            <label class="flex items-start gap-3 cursor-pointer group">
                <input
                    type="checkbox"
                    id="enabled"
                    name="enabled"
                    {% if config.enabled %}checked{% endif %}
                    class="mt-1 w-5 h-5 rounded border-dark-600 bg-dark-900 text-primary-600 focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-dark-800 cursor-pointer transition-colors">
                <div class="flex-1">
                    <span class="text-dark-200 font-medium group-hover:text-primary-400 transition-colors">Enable scheduled scans</span>
                    <p class="text-sm text-dark-400 mt-1">Automatically run deduplication scans on a schedule</p>
                </div>
            </label>

            <div>
                <label for="preset" class="flex items-center gap-2 text-sm text-dark-300 font-medium mb-2">
                    Preset Schedule
                    <button type="button"
                            data-tooltip="Choose a common schedule or enter a custom cron expression below. The preset will populate the cron field for you."
                            class="p-1 hover:bg-dark-700 rounded-full transition-colors"
                            aria-label="Help for preset schedule">
                        <svg class="w-4 h-4 text-dark-500 hover:text-primary-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </label>
                <select
                    id="preset"
                    onchange="applyPreset()"
                    class="w-full px-4 py-2 bg-dark-900 border border-dark-700 rounded-lg text-dark-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all cursor-pointer">
                    <option value="">-- Select a preset --</option>
                    {% for name, expr in presets.items() %}
                    <option value="{{ expr }}">{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="cron" class="block text-sm text-dark-300 font-medium mb-2">Cron Expression</label>
                <input
                    type="text"
                    id="cron"
                    name="cron"
                    value="{{ config.cron }}"
                    required
                    placeholder="0 2 * * 0"
                    oninput="validateCronExpression()"
                    class="w-full px-4 py-2 bg-dark-900 border border-dark-700 rounded-lg text-dark-200 placeholder-dark-500 font-mono focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                <p class="mt-2 text-sm text-dark-400">Format: <code class="bg-dark-900 px-1.5 py-0.5 rounded text-primary-400">minute hour day month day_of_week</code></p>

                <!-- Validation status -->
                <div id="cron-validation" class="mt-3 hidden">
                    <div id="cron-valid" class="hidden p-3 bg-green-900/30 border border-green-700/50 rounded-lg">
                        <div class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            <div class="flex-1">
                                <p class="text-green-300 font-medium mb-2">Valid cron expression</p>
                                <p class="text-sm text-green-200 mb-2">Next 5 run times:</p>
                                <ul id="next-runs" class="text-xs text-green-200 space-y-1 font-mono"></ul>
                            </div>
                        </div>
                    </div>
                    <div id="cron-invalid" class="hidden p-3 bg-red-900/30 border border-red-700/50 rounded-lg">
                        <div class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-red-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                            <div class="flex-1">
                                <p class="text-red-300 font-medium">Invalid cron expression</p>
                                <p id="cron-error" class="text-sm text-red-200 mt-1"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <label for="description" class="block text-sm text-dark-300 font-medium mb-2">Description</label>
                <input
                    type="text"
                    id="description"
                    name="description"
                    value="{{ config.description }}"
                    placeholder="Weekly scan on Sunday at 2 AM"
                    class="w-full px-4 py-2 bg-dark-900 border border-dark-700 rounded-lg text-dark-200 placeholder-dark-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
            </div>

            <div class="flex flex-col sm:flex-row gap-3 pt-2">
                <button
                    type="submit"
                    class="flex-1 sm:flex-none px-6 py-3 bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-medium rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-dark-800">
                    <span class="flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Save Schedule
                    </span>
                </button>
                <button
                    type="button"
                    onclick="location.reload()"
                    class="flex-1 sm:flex-none px-6 py-3 bg-dark-700 hover:bg-dark-600 text-dark-200 font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-dark-800">
                    Cancel
                </button>
            </div>
        </form>
    </div>

    <!-- Cron Expression Help Card -->
    <div class="bg-dark-800 border border-dark-700 rounded-xl p-6 shadow-xl">
        <h3 class="text-xl font-semibold text-dark-100 mb-4 pb-3 border-b border-dark-700">Cron Expression Help</h3>

        <div class="space-y-6">
            <div>
                <p class="text-dark-300 mb-3">A cron expression consists of 5 fields:</p>
                <div class="bg-dark-900 p-4 rounded-lg border border-dark-700">
                    <code class="text-primary-400 text-lg font-mono">minute  hour  day  month  day_of_week</code>
                </div>
            </div>

            <div class="grid sm:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-primary-400 font-semibold mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                        </svg>
                        Field Values
                    </h4>
                    <div class="space-y-2">
                        <div class="flex justify-between bg-dark-900/50 p-3 rounded-lg">
                            <span class="text-dark-200 font-medium">minute:</span>
                            <span class="text-dark-400">0-59</span>
                        </div>
                        <div class="flex justify-between bg-dark-900/50 p-3 rounded-lg">
                            <span class="text-dark-200 font-medium">hour:</span>
                            <span class="text-dark-400">0-23</span>
                        </div>
                        <div class="flex justify-between bg-dark-900/50 p-3 rounded-lg">
                            <span class="text-dark-200 font-medium">day:</span>
                            <span class="text-dark-400">1-31</span>
                        </div>
                        <div class="flex justify-between bg-dark-900/50 p-3 rounded-lg">
                            <span class="text-dark-200 font-medium">month:</span>
                            <span class="text-dark-400">1-12</span>
                        </div>
                        <div class="flex justify-between bg-dark-900/50 p-3 rounded-lg">
                            <span class="text-dark-200 font-medium">day_of_week:</span>
                            <span class="text-dark-400">0-6 (0=Sun)</span>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="text-primary-400 font-semibold mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                        </svg>
                        Special Characters
                    </h4>
                    <div class="space-y-2">
                        <div class="flex justify-between bg-dark-900/50 p-3 rounded-lg">
                            <code class="text-primary-400 font-bold">*</code>
                            <span class="text-dark-400">any value</span>
                        </div>
                        <div class="flex justify-between bg-dark-900/50 p-3 rounded-lg">
                            <code class="text-primary-400 font-bold">*/n</code>
                            <span class="text-dark-400">every n units</span>
                        </div>
                        <div class="flex justify-between bg-dark-900/50 p-3 rounded-lg">
                            <code class="text-primary-400 font-bold">n-m</code>
                            <span class="text-dark-400">range n to m</span>
                        </div>
                        <div class="flex justify-between bg-dark-900/50 p-3 rounded-lg">
                            <code class="text-primary-400 font-bold">n,m</code>
                            <span class="text-dark-400">values n and m</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-primary-900/20 border border-primary-700/50 rounded-lg p-4">
                <p class="text-dark-200 flex items-center gap-2">
                    <svg class="w-5 h-5 text-primary-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    <strong>Example:</strong>
                    <code class="bg-dark-900 px-2 py-1 rounded text-primary-400 mx-1">0 2 * * 0</code>
                    = Every Sunday at 2:00 AM
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let cronValidationTimeout = null;

    function applyPreset() {
        const preset = document.getElementById('preset').value;
        if (preset) {
            document.getElementById('cron').value = preset;
            validateCronExpression();
        }
    }

    function validateCronExpression() {
        const cronInput = document.getElementById('cron');
        const validation = document.getElementById('cron-validation');
        const validDiv = document.getElementById('cron-valid');
        const invalidDiv = document.getElementById('cron-invalid');
        const errorText = document.getElementById('cron-error');
        const nextRunsList = document.getElementById('next-runs');

        // Clear previous timeout
        if (cronValidationTimeout) {
            clearTimeout(cronValidationTimeout);
        }

        // Hide validation while typing
        validation.classList.add('hidden');
        validDiv.classList.add('hidden');
        invalidDiv.classList.add('hidden');

        // Debounce validation
        cronValidationTimeout = setTimeout(() => {
            const cronExpr = cronInput.value.trim();

            if (!cronExpr) {
                return;
            }

            fetch(`/api/schedule/preview?cron=${encodeURIComponent(cronExpr)}`)
                .then(response => response.json())
                .then(data => {
                    validation.classList.remove('hidden');

                    if (data.valid) {
                        validDiv.classList.remove('hidden');
                        invalidDiv.classList.add('hidden');

                        // Show next run times
                        nextRunsList.innerHTML = '';
                        data.next_runs.forEach((time, index) => {
                            const li = document.createElement('li');
                            li.textContent = `${index + 1}. ${time}`;
                            nextRunsList.appendChild(li);
                        });
                    } else {
                        validDiv.classList.add('hidden');
                        invalidDiv.classList.remove('hidden');
                        errorText.textContent = data.error || 'Invalid cron format';
                    }
                })
                .catch(error => {
                    console.error('Error validating cron:', error);
                    validation.classList.remove('hidden');
                    validDiv.classList.add('hidden');
                    invalidDiv.classList.remove('hidden');
                    errorText.textContent = 'Failed to validate cron expression';
                });
        }, 500);
    }

    // Validate on page load if there's a cron value
    document.addEventListener('DOMContentLoaded', () => {
        const cronInput = document.getElementById('cron');
        if (cronInput.value.trim()) {
            validateCronExpression();
        }
    });

    function saveSchedule(event) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');

        // Show loading state
        const originalContent = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="flex items-center justify-center gap-2"><svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Saving...</span>';

        const config = {
            enabled: formData.get('enabled') === 'on',
            cron: formData.get('cron'),
            description: formData.get('description')
        };

        fetch('/api/schedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        })
        .then(response => response.json())
        .then(data => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalContent;

            if (data.success) {
                showToast('Schedule saved successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Failed to save schedule: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalContent;
            showToast('Failed to save schedule', 'error');
        });
    }

    function triggerNow() {
        showModal(
            'Trigger Scan Now?',
            'This will start an immediate deduplication scan regardless of the schedule.',
            [
                {
                    text: 'Cancel',
                    primary: false
                },
                {
                    text: 'Trigger Scan',
                    primary: true,
                    onClick: () => {
                        fetch('/api/schedule/trigger', { method: 'POST' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    showToast('Scan triggered! Redirecting to dashboard...', 'success');
                                    setTimeout(() => window.location.href = '/', 1000);
                                } else {
                                    showToast('Failed to trigger scan', 'error');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                showToast('Failed to trigger scan', 'error');
                            });
                    }
                }
            ]
        );
    }
</script>
{% endblock %}
