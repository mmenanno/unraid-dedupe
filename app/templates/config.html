{% extends "base.html" %}
{% from 'macros/form_components.html' import icon, help_tooltip, remove_button, text_input_field, collapsible_section_header, collapsible_section_header_with_help, add_button, info_box, path_preference_field %}

{% block title %}Configuration - Unraid Dedupe{% endblock %}

{% block content %}
<div class="space-y-6" x-data="configPage()" x-init="init()">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <h2 class="text-3xl font-bold text-dark-50">Configuration</h2>
        <div class="flex gap-2">
            <button @click="exportConfig"
                    class="px-4 py-2 bg-dark-700 hover:bg-dark-600 text-dark-200 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 flex items-center gap-2">
                {{ icon('download') }}
                Export
            </button>
            <button @click="$refs.importInput.click()"
                    class="px-4 py-2 bg-dark-700 hover:bg-dark-600 text-dark-200 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 flex items-center gap-2">
                {{ icon('upload') }}
                Import
            </button>
            <input type="file" x-ref="importInput" accept=".json,.yaml,.yml" @change="importConfig($event)" class="hidden">
        </div>
    </div>

    <form id="config-form" @submit.prevent="saveConfig" class="space-y-6">
        <!-- Scan Paths Section -->
        <div class="bg-dark-800 border border-dark-700 rounded-xl shadow-xl overflow-hidden">
            {{ collapsible_section_header('scan-paths-section', 'Scan Paths', 'Directories to scan for duplicate files', 'folder', 'primary-400', true) }}
            <div id="scan-paths-section" class="px-6 pb-6 pt-4">
                <div id="scan-paths" class="space-y-3">
                    {% for path in config.scan_paths %}
                    {{ text_input_field('scan_paths[]', path, '/mnt/user/data', required=true) }}
                    {% endfor %}
                </div>
                {{ add_button('Add Path', 'addScanPath()') }}
            </div>
        </div>

        <!-- Exclude Patterns Section -->
        <div class="bg-dark-800 border border-dark-700 rounded-xl shadow-xl overflow-hidden">
            {{ collapsible_section_header('exclude-section', 'Exclude Patterns', 'Glob patterns for files/folders to skip', 'ban', 'yellow-400', true) }}
            <div id="exclude-section" class="px-6 pb-6 pt-4">
                {{ info_box('Use glob patterns like <code class="bg-dark-900 px-1.5 py-0.5 rounded">*.tmp</code> or <code class="bg-dark-900 px-1.5 py-0.5 rounded">*/.Trash-*</code><br><br><strong class="text-xs">Common patterns (click to add):</strong><br><div class="flex flex-wrap gap-2 mt-2">' +
                    '<button type="button" @click="addExcludePatternWithValue(\'*.tmp\')" class="px-2 py-1 bg-dark-900/50 hover:bg-dark-900 text-xs text-blue-300 rounded border border-blue-800 hover:border-blue-600 transition-all">*.tmp</button>' +
                    '<button type="button" @click="addExcludePatternWithValue(\'*/.Trash-*\')" class="px-2 py-1 bg-dark-900/50 hover:bg-dark-900 text-xs text-blue-300 rounded border border-blue-800 hover:border-blue-600 transition-all">*/.Trash-*</button>' +
                    '<button type="button" @click="addExcludePatternWithValue(\'*/System Volume Information/*\')" class="px-2 py-1 bg-dark-900/50 hover:bg-dark-900 text-xs text-blue-300 rounded border border-blue-800 hover:border-blue-600 transition-all">System Volume Info</button>' +
                    '<button type="button" @click="addExcludePatternWithValue(\'*/@eaDir/*\')" class="px-2 py-1 bg-dark-900/50 hover:bg-dark-900 text-xs text-blue-300 rounded border border-blue-800 hover:border-blue-600 transition-all">Synology @eaDir</button>' +
                    '<button type="button" @click="addExcludePatternWithValue(\'*/._*\')" class="px-2 py-1 bg-dark-900/50 hover:bg-dark-900 text-xs text-blue-300 rounded border border-blue-800 hover:border-blue-600 transition-all">macOS Resource Forks</button>' +
                    '<button type="button" @click="addExcludePatternWithValue(\'*.log\')" class="px-2 py-1 bg-dark-900/50 hover:bg-dark-900 text-xs text-blue-300 rounded border border-blue-800 hover:border-blue-600 transition-all">*.log</button>' +
                    '</div>') }}
                <div id="exclude-patterns" class="space-y-3">
                    {% for pattern in config.exclude_patterns %}
                    {{ text_input_field('exclude_patterns[]', pattern, '*.tmp', mono=true) }}
                    {% endfor %}
                </div>
                {{ add_button('Add Pattern', 'addExcludePattern()') }}
            </div>
        </div>

        <!-- Path Preferences Section -->
        <div class="bg-dark-800 border border-dark-700 rounded-xl shadow-xl overflow-hidden">
            {{ collapsible_section_header_with_help('prefs-section', 'Path Preferences', 'Define which locations to prefer when choosing keepers', 'clipboard', 'purple-400', 'Path preferences determine which file to keep when duplicates are found. Lower priority numbers mean higher preference. For example, priority 1 files are kept over priority 2 files.', true) }}
            <div id="prefs-section" class="px-6 pb-6 pt-4">
                {{ info_box('Lower priority number = higher preference. Files matching the lowest priority become keepers.', 'purple') }}
                <div id="path-preferences" class="space-y-3">
                    {% for pref in config.path_preferences %}
                    {{ path_preference_field(pref.pattern, pref.priority) }}
                    {% endfor %}
                </div>
                {{ add_button('Add Preference', 'addPathPreference()') }}
            </div>
        </div>

        <!-- Rmlint Options Section -->
        <div class="bg-dark-800 border border-dark-700 rounded-xl shadow-xl overflow-hidden">
            {{ collapsible_section_header_with_help('rmlint-section', 'Rmlint Options', 'Checksum algorithm configuration', 'settings', 'green-400', 'Rmlint uses checksums to identify duplicate files. xxhash is fastest and recommended for most users. SHA256/SHA512 provide cryptographic security but are slower.', false) }}
            <div id="rmlint-section" class="hidden px-6 pb-6 pt-4 rounded-b-xl">
                <label class="block text-sm text-dark-300 font-medium mb-2">Algorithm</label>
                <select
                    id="algorithm"
                    name="algorithm"
                    @change="markFormDirty"
                    class="w-full px-4 py-2 bg-dark-900 border border-dark-700 rounded-lg text-dark-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all cursor-pointer">
                    <option value="xxhash" {% if config.rmlint_options.algorithm == 'xxhash' %}selected{% endif %}>xxhash (fast, recommended)</option>
                    <option value="sha256" {% if config.rmlint_options.algorithm == 'sha256' %}selected{% endif %}>sha256 (secure)</option>
                    <option value="sha512" {% if config.rmlint_options.algorithm == 'sha512' %}selected{% endif %}>sha512 (most secure)</option>
                </select>
                <p class="mt-2 text-sm text-dark-400">xxhash provides the best balance of speed and reliability for most use cases.</p>
            </div>
        </div>

        <!-- Safety Options Section -->
        <div class="bg-dark-800 border border-dark-700 rounded-xl shadow-xl overflow-hidden">
            {{ collapsible_section_header('safety-section', 'Safety Options', 'Verification and backup settings', 'shield', 'blue-400', false) }}
            <div id="safety-section" class="hidden px-6 pb-6 pt-4 space-y-4">
                <!-- Cross-disk action warning -->
                <div x-show="crossDiskAction === 'delete_duplicate'" x-cloak class="p-4 bg-red-900/30 border-2 border-red-700 rounded-lg">
                    <div class="flex items-start gap-3">
                        {{ icon('warning', 'w-6 h-6 text-red-400 flex-shrink-0 mt-0.5') }}
                        <div class="flex-1">
                            <h4 class="text-red-300 font-bold mb-2">⚠️ DANGER: Cross-Disk Delete Enabled</h4>
                            <p class="text-red-200 text-sm mb-2">
                                This setting will <strong>permanently delete files</strong> on other disks!
                                You will lose redundancy across disks and files cannot be recovered.
                            </p>
                            <p class="text-red-200 text-sm">
                                Only enable this if you understand the consequences and have backups.
                            </p>
                        </div>
                    </div>
                </div>

                <label class="flex items-start gap-3 cursor-pointer group">
                    <input
                        type="checkbox"
                        name="verify_after_hardlink"
                        @change="markFormDirty"
                        {% if config.safety.verify_after_hardlink %}checked{% endif %}
                        class="mt-1 w-5 h-5 rounded border-dark-600 bg-dark-900 text-primary-600 focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-dark-800 cursor-pointer transition-colors">
                    <div class="flex-1">
                        <span class="text-dark-200 font-medium group-hover:text-primary-400 transition-colors">Verify after hardlink</span>
                        <p class="text-sm text-dark-400 mt-1">Compares inodes after creating hardlinks to ensure correctness</p>
                    </div>
                </label>
                <label class="flex items-start gap-3 cursor-pointer group">
                    <input
                        type="checkbox"
                        name="keep_backups"
                        @change="markFormDirty"
                        {% if config.safety.keep_backups %}checked{% endif %}
                        class="mt-1 w-5 h-5 rounded border-dark-600 bg-dark-900 text-primary-600 focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-dark-800 cursor-pointer transition-colors">
                    <div class="flex-1">
                        <span class="text-dark-200 font-medium group-hover:text-primary-400 transition-colors">Keep backups</span>
                        <p class="text-sm text-dark-400 mt-1">Keeps .backup files (not recommended for production)</p>
                    </div>
                </label>

                <div>
                    <label class="block text-sm text-dark-300 font-medium mb-2">Cross-Disk Action <span class="text-red-400">*</span></label>
                    <select
                        id="cross-disk-action"
                        name="cross_disk_action"
                        x-model="crossDiskAction"
                        @change="markFormDirty"
                        class="w-full px-4 py-2 bg-dark-900 border border-dark-700 rounded-lg text-dark-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all cursor-pointer">
                        <option value="skip" {% if config.safety.get('cross_disk_action', 'skip') == 'skip' %}selected{% endif %}>Skip (Safest - Do Nothing)</option>
                        <option value="manual_review" {% if config.safety.get('cross_disk_action') == 'manual_review' %}selected{% endif %}>Manual Review (Log for Review)</option>
                        <option value="delete_duplicate" {% if config.safety.get('cross_disk_action') == 'delete_duplicate' %}selected{% endif %}>Delete Duplicate (DANGEROUS!)</option>
                    </select>
                    <p class="mt-2 text-sm text-dark-400">Hardlinks only work on the same disk. Choose how to handle duplicates across different disks.</p>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div x-show="isDirty" x-cloak
             class="flex flex-col sm:flex-row gap-3 sticky bottom-4 bg-dark-900/95 backdrop-blur-lg border border-dark-700 rounded-xl p-4 shadow-2xl transition-all">
            <button
                type="button"
                @click="validateConfig"
                class="flex-1 sm:flex-none px-6 py-3 bg-dark-700 hover:bg-dark-600 text-dark-200 font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-dark-900">
                <span class="flex items-center justify-center gap-2">
                    {{ icon('check-circle') }}
                    Validate Configuration
                </span>
            </button>
            <button
                type="submit"
                class="flex-1 sm:flex-none px-6 py-3 bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-medium rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-dark-900">
                <span class="flex items-center justify-center gap-2">
                    {{ icon('check') }}
                    Save Configuration
                </span>
            </button>
            <button
                type="button"
                @click="location.reload()"
                class="flex-1 sm:flex-none px-6 py-3 bg-dark-700 hover:bg-dark-600 text-dark-200 font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-dark-900">
                Cancel
            </button>
        </div>
    </form>
</div>

<!-- HTML Templates for Dynamic Fields -->
<template id="scan-path-template">
    <div class="flex gap-2" data-field>
        <input
            type="text"
            name="scan_paths[]"
            required
            placeholder="/mnt/user/data"
            class="flex-1 px-4 py-2 bg-dark-900 border border-dark-700 rounded-lg text-dark-200 placeholder-dark-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
            aria-label="Scan path">
        <button
            type="button"
            data-action="remove"
            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-500"
            aria-label="Remove path">
            <svg class="w-5 h-5"><use href="/static/icons.svg#icon-trash"/></svg>
        </button>
    </div>
</template>

<template id="exclude-pattern-template">
    <div class="flex gap-2" data-field>
        <input
            type="text"
            name="exclude_patterns[]"
            placeholder="*.tmp"
            class="flex-1 px-4 py-2 bg-dark-900 border border-dark-700 rounded-lg text-dark-200 placeholder-dark-500 font-mono text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
            aria-label="Exclude pattern">
        <button
            type="button"
            data-action="remove"
            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-500"
            aria-label="Remove pattern">
            <svg class="w-5 h-5"><use href="/static/icons.svg#icon-trash"/></svg>
        </button>
    </div>
</template>

<template id="path-preference-template">
    <div class="grid sm:grid-cols-[1fr_auto_auto] gap-2 items-start bg-dark-900/50 p-3 rounded-lg border border-dark-700" data-field>
        <div>
            <label class="block text-xs text-dark-400 uppercase tracking-wider mb-1">Pattern</label>
            <input
                type="text"
                name="pref_pattern[]"
                required
                placeholder="/mnt/user/data/*"
                class="w-full px-3 py-2 bg-dark-900 border border-dark-700 rounded-lg text-dark-200 placeholder-dark-500 font-mono text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
        </div>
        <div>
            <label class="block text-xs text-dark-400 uppercase tracking-wider mb-1">Priority</label>
            <input
                type="number"
                name="pref_priority[]"
                required
                min="1"
                value="1"
                class="w-24 px-3 py-2 bg-dark-900 border border-dark-700 rounded-lg text-dark-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
        </div>
        <div class="sm:pt-6">
            <button
                type="button"
                data-action="remove"
                class="w-full sm:w-auto px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-500"
                aria-label="Remove preference">
                <svg class="w-5 h-5"><use href="/static/icons.svg#icon-trash"/></svg>
            </button>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
// Alpine.js component for config page
function configPage() {
    return {
        isDirty: false,
        crossDiskAction: '{{ config.safety.get("cross_disk_action", "skip") }}',

        init() {
            // Initialize chevrons based on current aria-expanded state
            document.querySelectorAll('[aria-controls]').forEach(button => {
                const chevron = button.querySelector('.section-chevron');
                const isExpanded = button.getAttribute('aria-expanded') === 'true';
                if (chevron) {
                    chevron.style.transform = isExpanded ? 'rotate(0)' : 'rotate(-90deg)';
                }
            });

            // Event delegation for form changes
            const form = document.getElementById('config-form');
            form.addEventListener('input', () => this.markFormDirty());
            form.addEventListener('change', () => this.markFormDirty());

            // Event delegation for remove buttons
            form.addEventListener('click', (e) => {
                if (e.target.closest('[data-action="remove"]')) {
                    e.target.closest('[data-field]').remove();
                    this.markFormDirty();
                }
            });
        },

        markFormDirty() {
            this.isDirty = true;
        },

        markFormClean() {
            this.isDirty = false;
        },

        // Build config from form data (single source of truth)
        buildConfigFromForm(formData) {
            const patterns = formData.getAll('pref_pattern[]');
            const priorities = formData.getAll('pref_priority[]');
            const pathPreferences = [];

            for (let i = 0; i < patterns.length; i++) {
                if (patterns[i]) {
                    pathPreferences.push({
                        pattern: patterns[i],
                        priority: parseInt(priorities[i])
                    });
                }
            }

            return {
                scan_paths: formData.getAll('scan_paths[]').filter(v => v),
                exclude_patterns: formData.getAll('exclude_patterns[]').filter(v => v),
                path_preferences: pathPreferences,
                rmlint_options: {
                    algorithm: formData.get('algorithm')
                },
                safety: {
                    verify_after_hardlink: formData.get('verify_after_hardlink') === 'on',
                    keep_backups: formData.get('keep_backups') === 'on',
                    cross_disk_action: formData.get('cross_disk_action')
                }
            };
        },

        // Add field from template
        addFieldFromTemplate(containerId, templateId, focusSelector = 'input') {
            const container = document.getElementById(containerId);
            const template = document.getElementById(templateId);
            const clone = template.content.cloneNode(true);
            container.appendChild(clone);
            container.lastElementChild.querySelector(focusSelector)?.focus();
            this.markFormDirty();
        },

        exportConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(config => {
                    const dataStr = JSON.stringify(config, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    link.download = `dedupe-config-${timestamp}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    showToast('Configuration exported successfully!', 'success');
                })
                .catch(error => {
                    console.error('Export failed:', error);
                    showToast('Failed to export configuration', 'error');
                });
        },

        importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const config = JSON.parse(e.target.result);

                    // Validate config structure
                    if (!config.scan_paths || !config.rmlint_options || !config.safety) {
                        throw new Error('Invalid configuration file structure');
                    }

                    // Show confirmation modal
                    showModal(
                        'Import Configuration?',
                        `This will replace your current configuration with settings from "${file.name}". Your current settings will be lost. Continue?`,
                        [
                            { text: 'Cancel', primary: false },
                            {
                                text: 'Import',
                                danger: true,
                                onClick: () => {
                                    fetch('/api/config', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(config)
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            showToast('Configuration imported successfully! Reloading...', 'success');
                                            setTimeout(() => location.reload(), 1500);
                                        } else {
                                            showToast('Failed to import: ' + data.error, 'error');
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Import failed:', error);
                                        showToast('Failed to import configuration', 'error');
                                    });
                                }
                            }
                        ]
                    );
                } catch (error) {
                    console.error('Parse error:', error);
                    showToast('Invalid configuration file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);

            // Reset input so same file can be imported again
            event.target.value = '';
        },

        validateConfig() {
            const formData = new FormData(document.getElementById('config-form'));
            const config = this.buildConfigFromForm(formData);

            fetch('/api/config/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    let message = 'Configuration is valid!';
                    if (data.warnings && data.warnings.length > 0) {
                        message += '\n\nWarnings:\n' + data.warnings.join('\n');
                        showModal('Validation Successful (with warnings)', message, [
                            { text: 'OK', primary: true }
                        ]);
                    } else {
                        showToast(message, 'success');
                    }
                } else {
                    let message = 'Configuration has errors:\n\n' + data.errors.join('\n');
                    if (data.warnings && data.warnings.length > 0) {
                        message += '\n\nWarnings:\n' + data.warnings.join('\n');
                    }
                    showModal('Validation Failed', message, [
                        { text: 'OK', primary: false }
                    ]);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Failed to validate configuration', 'error');
            });
        },

        saveConfig(event) {
            const form = event.target;
            const formData = new FormData(form);
            const submitBtn = form.querySelector('button[type="submit"]');

            if (!submitBtn) {
                console.error('Submit button not found');
                showToast('Failed to save configuration', 'error');
                return;
            }

            // Show loading state
            const originalContent = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="flex items-center justify-center gap-2"><svg class="animate-spin h-5 w-5"><use href="/static/icons.svg#icon-spinner"/></svg>Saving...</span>';

            const config = this.buildConfigFromForm(formData);

            // Send to API
            fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalContent;

                if (data.success) {
                    showToast('Configuration saved successfully!', 'success');
                    this.markFormClean();
                } else {
                    showToast('Failed to save configuration: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalContent;
                showToast('Failed to save configuration', 'error');
            });
        }
    };
}

// Legacy functions for onclick handlers (for backward compatibility)
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    const button = document.querySelector(`[aria-controls="${sectionId}"]`);

    if (!section || !button) return;

    const chevron = button.querySelector('.section-chevron');
    const isExpanded = button.getAttribute('aria-expanded') === 'true';

    if (isExpanded) {
        section.classList.add('hidden');
        button.setAttribute('aria-expanded', 'false');
        if (chevron) chevron.style.transform = 'rotate(-90deg)';
    } else {
        section.classList.remove('hidden');
        button.setAttribute('aria-expanded', 'true');
        if (chevron) chevron.style.transform = 'rotate(0)';
    }
}

function addScanPath() {
    const alpineData = Alpine.$data(document.querySelector('[x-data]'));
    alpineData.addFieldFromTemplate('scan-paths', 'scan-path-template');
}

function addExcludePattern() {
    const alpineData = Alpine.$data(document.querySelector('[x-data]'));
    alpineData.addFieldFromTemplate('exclude-patterns', 'exclude-pattern-template');
}

function addExcludePatternWithValue(value) {
    const alpineData = Alpine.$data(document.querySelector('[x-data]'));
    alpineData.addFieldFromTemplate('exclude-patterns', 'exclude-pattern-template');
    const container = document.getElementById('exclude-patterns');
    const lastInput = container.lastElementChild.querySelector('input');
    if (lastInput) {
        lastInput.value = value;
    }
    showToast(`Added pattern: ${value}`, 'success');
}

function addPathPreference() {
    const alpineData = Alpine.$data(document.querySelector('[x-data]'));
    alpineData.addFieldFromTemplate('path-preferences', 'path-preference-template');
}

function removeField(element) {
    element.remove();
    const alpineData = Alpine.$data(document.querySelector('[x-data]'));
    alpineData.markFormDirty();
}
</script>

<style>
/* Alpine.js cloak */
[x-cloak] { display: none !important; }
</style>
{% endblock %}
